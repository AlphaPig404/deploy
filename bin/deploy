#! /usr/bin/env node
const shelljs = require('shelljs')
const path = require('path')
const fs = require('fs')
const chalk = require('chalk')
const bold = chalk.green.underline.bold
const warning = chalk.keyword('orange')
const packageJson = fs.readFileSync(resolve('./package.json'),'utf8')
const _package = JSON.parse(packageJson)
const {start} = require('../index')

const argv = require('yargs')
  .command('init', 'init deploy config', (yargs) => {}, (argv) => {
    initConfig(argv.env)
  })
  .command('start', 'start deploy', (yargs) => {}, (argv) => {
    startDeploy(argv.env)
  })
  .argv

function resolve(_path){
    return path.resolve(process.env.PWD, _path);
}

function initConfig(env){
    const defaultConf = {
        name: '',
        host: '',
        port: 22,
        username: '${Username for authentication}',
        password: '${Your local filePath of password}',
        remotePath: '${Your remote path}',
        remoteDirName: '${Dest dir name}',
        dist: '${Your local dist path}'
    }
    try{
        const isExists = fs.existsSync(resolve(`./deploy.${env}.conf`))
        if(isExists){
            console.log(`${warning(`deploy.${env}.conf already exists:`)}: Config ${bold(`deploy.${env}.conf`)} firstly and use ${bold(`npm run deploy:${env}`)}`);
            return;
        }
        fs.writeFileSync(resolve(`./deploy.${env}.conf`), JSON.stringify(defaultConf, null, 4))
        _package.scripts[`deploy:${env}`] = `deploy-loopslive-web start --env ${env}`
        const str = JSON.stringify(_package, null, 4)
        fs.writeFileSync(resolve('./package.json'),str)
        console.log(`${warning(`deploy ${env}:`)}: Config ${bold(`deploy.${env}.conf`)} firstly and use ${bold(`npm run deploy:${env}`)}`);
        console.log(`deploy init done~!`)
    }catch(err){
        console.log(err)
    }
}

function startDeploy(env){
    try{
        const jsonFile = fs.readFileSync(resolve(`./deploy.${env}.conf`))
        const options = JSON.parse(jsonFile)

        const arr = Object.keys(options).filter(key => !options[key])
        if(arr.length){
           const str = arr.join(',')
           console.log(`${bold(str)}  is required in ${bold(`deploy.${env}.conf`)} `)
        }else{
            process.env.DEPLOY_ENV = env
            start()
        } 
    }catch(err){
        initConfig(env)
    }
}






